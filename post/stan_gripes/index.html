<!DOCTYPE html>
<html lang='en'>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/arduino-light.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/stan.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='My gripes with my favorite stats program'>

<meta property='og:title' content='A few things I don&#39;t love about Stan • Matt Espe'>
<meta property='og:description' content='My gripes with my favorite stats program'>
<meta property='og:url' content='/post/stan_gripes/'>
<meta property='og:site_name' content='Thousand words...'>
<meta property='og:type' content='article'><meta property='article:publisher' content='https://facebook.com/bob'><meta property='article:section' content='Post'><meta property='article:tag' content='Stan'><meta property='article:tag' content='stats'><meta property='article:published_time' content='2017-08-24T20:51:22-07:00'/><meta property='article:modified_time' content='2017-08-24T20:51:22-07:00'/>

<meta name="generator" content="Hugo 0.27-DEV" />

  <title>A few things I don&#39;t love about Stan • Matt Espe</title>
  <link rel='canonical' href='/post/stan_gripes/'>
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Ubuntu:400,400i,700&subset=latin'>
<link rel='stylesheet' href='/css/main.d02777fd.css'>

  <link rel='stylesheet' href='/css/custom.css'>



</head>


<body class='page'>
  <div class='site'>
    <header id='header' class='header-container'>
      <div class='site-header'>
        <nav id='navmenu' aria-label='Main Menu'>
  <ul class='main-menu'>
    
    <li>
      <a href='/' 
        
      >Home</a>
    </li>
    
    <li>
      <a href='/post/' 
        
      >Blog</a>
    </li>
    
    <li>
      <a href='/about/' 
        
      >About me</a>
    </li>
    
    <li>
      <a href='/research/' 
        
      >Research</a>
    </li>
    
    <li>
      <a href='https://github.com/mespe' 
        
      >Repos</a>
    </li>
    
    <li>
      <a href='/docs/espe_cv.pdf' 
        
      >CV</a>
    </li>
    
  </ul>
</nav>

        <div class='site-info'>
          
          <p class='site-title title'>Thousand words...</p>
          
          <p class='site-description'>Thoughts on agriculture, data science, and academia</p>
        </div>
      </div>
    </header>


<main class='main'>
  <article lang='en' class='entry'>
    <header class='entry-header'>
  <div class='entry-info'>
    <h1 class='entry-title title'>A few things I don&#39;t love about Stan</h1>
    
    <p class='entry-subtitle'>
      My gripes with my favorite stats program
    </p>
    
  </div>
  
<div class='meta'>
  <span class='posted-on'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>

    <span class='screen-reader'>Posted on </span>
    <time class='date' datetime='2017-08-24T20:51:22-07:00'>2017, Aug 24</time>
  </span>
  
  <span class='byline'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>

    <span class='screen-reader'> by </span>
    Matt Espe
  </span>
  
  
  <span class='reading-time'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/> 
  
</svg>

    4 mins read
  </span>
  
</div>


</header>

    <div class='entry-content'>
  

<p>First off, I love <a href="mcstan.org">Stan</a>. If you have not heard of Stan, I
highly recommend you check it out. I use Stan for almost all of my
statistics these days, and have published several papers using it.</p>

<p>That said, there are a fair number of things I don&rsquo;t like about it:</p>

<h1 id="the-model-trade-offs">The model trade-offs</h1>

<p>In my experience, when you are developing a model in Stan, you are
often faced with trade-offs between 1) flexibility, 2) readability,
and 3) development time.</p>

<p>To illustrate with a silly example, say I had a basic model:</p>
<div class="highlight" style="background: #2f1e2e"><pre style="line-height: 125%"><span></span><span style="color: #5bc4bf">data</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">int</span> <span style="color: #e7e9db">N;</span>
  <span style="color: #fec418">vector</span><span style="color: #e7e9db">[N]</span> <span style="color: #e7e9db">y;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">parameters</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">real</span> <span style="color: #e7e9db">mu;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">model</span><span style="color: #e7e9db">{</span>
  <span style="color: #e7e9db">target</span> <span style="color: #5bc4bf">+=</span> <span style="color: #e7e9db">normal_lpdf(y</span> <span style="color: #ef6155">|</span> <span style="color: #e7e9db">mu,</span> <span style="color: #f99b15">1</span><span style="color: #e7e9db">);</span>
<span style="color: #e7e9db">}</span>
</pre></div>

<p>This model is simple and easy to read, but it is not flexible. To make
this model take a number of predictors, I have to modify the code:</p>
<div class="highlight" style="background: #2f1e2e"><pre style="line-height: 125%"><span></span><span style="color: #5bc4bf">data</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">int</span> <span style="color: #e7e9db">N;</span>
  <span style="color: #fec418">vector</span><span style="color: #e7e9db">[N]</span> <span style="color: #e7e9db">predictor;</span>
  <span style="color: #fec418">vector</span><span style="color: #e7e9db">[N]</span> <span style="color: #e7e9db">y;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">parameters</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">real</span> <span style="color: #e7e9db">beta;</span>
  <span style="color: #fec418">real</span> <span style="color: #e7e9db">mu;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">model</span><span style="color: #e7e9db">{</span>
  <span style="color: #e7e9db">target</span> <span style="color: #5bc4bf">+=</span> <span style="color: #e7e9db">normal_lpdf(y</span> <span style="color: #ef6155">|</span> <span style="color: #e7e9db">mu</span> <span style="color: #5bc4bf">+</span> <span style="color: #e7e9db">beta</span> <span style="color: #5bc4bf">*</span> <span style="color: #e7e9db">predictor,</span> <span style="color: #f99b15">1</span><span style="color: #e7e9db">);</span>
<span style="color: #e7e9db">}</span>
</pre></div>

<p>Creating this little change would mean sitting through compiling the
model again. Doing this once or twice is not so bad, but when I am
working with a model this could be up to 20 or 30 times. That really
adds up.</p>

<p>Second, each time I edit the model, there is the potential to
introduce errors. Therefore, in addition to the compiling time, there
is time spent debugging, etc.</p>

<p>So, instead of all of this, I could have coded the model as:</p>
<div class="highlight" style="background: #2f1e2e"><pre style="line-height: 125%"><span></span><span style="color: #5bc4bf">data</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">int</span> <span style="color: #e7e9db">N;</span>
  <span style="color: #fec418">int</span> <span style="color: #e7e9db">num_pred;</span> <span style="color: #776e71">//number of predictors</span>
  <span style="color: #fec418">matrix</span><span style="color: #e7e9db">[N,</span> <span style="color: #e7e9db">num_pred]</span> <span style="color: #e7e9db">X;</span> <span style="color: #776e71">//model matrix</span>
  <span style="color: #fec418">vector</span><span style="color: #e7e9db">[N]y;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">parameters</span><span style="color: #e7e9db">{</span>
  <span style="color: #fec418">vector</span><span style="color: #e7e9db">[num_pred]</span> <span style="color: #e7e9db">beta;</span>
<span style="color: #e7e9db">}</span>
<span style="color: #5bc4bf">model</span><span style="color: #e7e9db">{</span>
  <span style="color: #e7e9db">target</span> <span style="color: #5bc4bf">+=</span> <span style="color: #e7e9db">normal_lpdf(y</span> <span style="color: #ef6155">|</span> <span style="color: #e7e9db">beta</span> <span style="color: #5bc4bf">*</span> <span style="color: #e7e9db">X,</span> <span style="color: #f99b15">1</span><span style="color: #e7e9db">);</span>
<span style="color: #e7e9db">}</span>
</pre></div>

<p>This model is actually the same as both of the models above. Compared
to those, it is much more flexible. This model can accept countless
number of predictors without changing the Stan code at all. All that
compiler time is gone, as is the time spent debugging and checking the
model.</p>

<p>So, you might say this is clearly the winner, right?</p>

<p>Well, I actually prefer the first way because:</p>

<ol>
<li><p>The model code is expressive of what happening in the analysis. Though it
is more inefficient on several fronts, this code allows someone to see
exactly what is happening. Looking at the more efficient model, a
reader will not have a clue how many predictors were used, what
their types were, etc. An extreme example of this is the model code
for
the
<a href="https://github.com/stan-dev/rstanarm/tree/master/inst/chunks">rstanarm package</a> for
R. These models are extremely flexible and highly efficient, but
almost impossible to tell on first glance what is going on.</p></li>

<li><p>The inefficiency can be a feature. More than once I have been
forced to actually spell out the math in the models I am creating,
rather than just relying on the &ldquo;throw it in a model matrix and it just
runs&rdquo; approach. For me, forcing me to slow down and think
deliberately about my model is helpful.</p></li>

<li><p>Verbose models are often easier for people with little statistics
experience to approach. As I think more and more about reproducible
research, the more I think I would happily trade some wall time for
a model that more readers can understand and even potentially
modify.</p></li>
</ol>

<h1 id="so-what-s-the-issue">So what&rsquo;s the issue?</h1>

<p>Those compile and testing times are killing me. Developing models as
part of my analysis is slow. When a project comes up that needs an
answer ASAP, I will often resort to rstanarm or even lme4. But for
something I am going to publish alongside a manuscript, I prefer the
slower approach.</p>

<p>My wish list then is:</p>

<ol>
<li><p>A testing framework that will work for custom written models to
quickly evaluate that they are performing as intended.</p></li>

<li><p>Custom Bayesian models that have the speed of compiled code, but without
the lengthy compile times. I would trade a little wall time for
reduced compile times.</p></li>
</ol>

<p>Which makes me wonder what potential exists in 1) Nimble compiled with
LLVM, 2) Julia, or 3) Go. Go is the most intriguing to me - it is
almost as fast as C++, but compiles ridiculously quickly. Hmmm&hellip;</p>

</div>

    
<footer class='entry-footer'>
  
    
      
      

<div class='categories'>
  <span class='category-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>

  </span>
  <span class='screen-reader'>Categories: </span><a class='category' href='/categories/'></a></div>

    
  
    
      
      

<div class='tags'>
  <span class='tag-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>

  </span>
  <span class='screen-reader'>Tags: </span><a class='tag' href='/tags/stan'>Stan</a>, <a class='tag' href='/tags/stats'>stats</a></div>

    
  
</footer>


  </article>

  
    
<nav class='entry-nav'>
  <div class='entry-nav-links'><div class='prev-entry'>
      <a href='/post/new_v_old/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader'>Previous post: </span>Moving past p-values</a>
    </div></div>
</nav>


  

  
    <div class='comments-container'>
  
</div>

  
</main>

    <footer id='footer' class='footer-container'>
      <div class='footer'>
        <div class='social'>
  <nav aria-label='Social Menu'>
    <ul class='social-menu'><li>
        <a href='mailto:mespe@ucdavis.edu' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Email account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>

        </a>
      </li><li>
        <a href='https://github.com/mespe' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Github account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>

        </a>
      </li><li>
        <a href='https://twitter.com/mespe' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Twitter account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>

        </a>
      </li></ul>
  </nav>
</div>

        <div class='copyright'>
          <p>
    
  
  &copy; 2017 Matt Espe</p>

        </div>
      </div>
    </footer>

  </div>

  <script src='/js/main.af838dd5.js'></script>
  
    <script src='/js/custom.js'></script>
  

</body>

</html>

